### 业务流程分析

#### 新用户注册发放优惠券业务流程

**功能需求分析**

1、使用邮箱注册，发送邮箱验证码，已经注册的邮箱不能重复注册

2、用户密码加密，并在性能和安全性之间权衡选择合适的加密方式

3、用户上传头像需要用阿里云OSS(Object Storage Service)文件存储



**安全需求分析**

1、高并发下邮箱唯一性

2、注册邮箱或者手机验证码不能被恶意调用

3、头像文件存储访问方便扩容和管理

 

**用户注册时序分析**

​		电商平台中，为了拉取新用户的流量，对于新用户的注册会有新用户领取优惠券的活动，实际生产环境中，注册是一个比较复杂的业务流程，关系到分布式部署下图形验证码的验证过程，存储过程。用户账号的唯一性检查，邮箱或手机验证码的发送，不同微服务之间的交互，比如用户服务调用优惠券服务的领取新用户优惠券的功能等等。

![img](E:\typora_img\wps1.jpg)

<center>图 新用户注册发放优惠券时序图</center>

 

 

 

#### **高并发场景下领取优惠券业务流程**

**单用户超领优惠券问题：**

优惠券限制1人限制1张，有些人却领了2张，利用暂停思维来发现问题，
假设领券流程为先判断优惠券是否可领，然后扣减库存并添加领券记录，流程图如下

![img](E:\typora_img\wps2.jpg)

<center>图 一般优惠券领取流程</center>

​		在这种流程下，考虑同一用户的AB线程，A线程先判断可领优惠券，但是由于某种原因导致扣减库存的流程执行的很慢，这时候B线程进来判断优惠券是否可领，由于这时候A线程扣减库存并未执行，所以B线程查询数据库判断条件的结果和A线程一样，也可以领取优惠券，当A、B两个线程都执行完成后就会出现两个线程都领取优惠券成功的情况，即在1人限制领取1张优惠券的情况下领取了2张优惠券，流程图如下：

![img](E:\typora_img\wps3.jpg)

<center>图 单用户优惠券超领问题分析</center>

 

**单用户超领优惠券问题的解决方案：**

​		对于单用户超领优惠券问题，考虑引入redis分布式锁，在每次请求领取优惠券之前请求对该优惠券加上分布式锁，以独占的方式访问这个优惠券资源，如果上锁成功，那么执行接下来的业务逻辑，如果上锁失败，那么该线程会被阻塞并自旋等待。直到上一个线程释放这个优惠券的分布式锁才可以执行接下来的业务逻辑。完成业务流程如下图所示：

![img](E:\typora_img\wps4.jpg)

<center>图 引入分布式锁的单用户超领优惠券问题解决流程</center>

 

#### 用户下单商品库存扣减业务流程

​		电商系统中，用户购买商品确认下单是一种常见的高并发场景，对于数据一致性方案，强一致性框架Seata，无论它的性能如何优越，一旦在项目链路中加入分布式事务，系统整体效率会几倍的下降，在高并发场景下弊端尤为明显，所以对于分布式事务，除了特定的强一致性场景之外，能不用尽量就不要用。

 

**非分布式事务解决方案——服务自管理（最终一致性）**

1、商品服务扣减库存前保存一个Task任务，记录扣减的商品、数量还有关联的订单id（需要保证扣减库存和保存Task任务在同一个事务里面）

2、然后使用定时Task任务表扫描（库存允许一定时间内不同步，只需满足最终一致性即可）

1）订单超时关闭或取消：直接通过Task任务恢复商品库存。

2）订单不存在：下单、锁定库存后，程序问题导致订单异常回滚，定时扫描查询不到订单，则通过Task任务恢复商品库存

![img](E:\typora_img\wps5.jpg)

<center>图 商品微服务自管理模型</center>

 

**通过消息队列实现的服务自管理下单流程**

定时任务Task表锁定记录状态lock_state定义：

| ***\*lock_stat\*******\*e关键字\**** | ***\*含义\**** | ***\*表示\****                         |
| ------------------------------------ | -------------- | -------------------------------------- |
| LOCK                                 | 锁定           | 商品/优惠券锁定，等待确认订单状态      |
| FINISH                               | 完成           | 订单确认已支付，库存已扣减             |
| CANCEL                               | 取消           | 订单超时未支付、取消、不存在，恢复库存 |

![img](E:\typora_img\wps6.jpg)

<center>图10 用户下单架构流程图</center>
